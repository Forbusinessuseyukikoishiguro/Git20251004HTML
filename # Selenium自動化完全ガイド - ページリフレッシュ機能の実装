# Seleniumè‡ªå‹•åŒ–å®Œå…¨ã‚¬ã‚¤ãƒ‰ - ãƒšãƒ¼ã‚¸ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥æ©Ÿèƒ½ã®å®Ÿè£…

ãƒšãƒ¼ã‚¸ã®å†èª­ã¿è¾¼ã¿ã¯ã€å‹•çš„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®æ›´æ–°ç¢ºèªã‚„ãƒ†ã‚¹ãƒˆã®åˆæœŸåŒ–ã«æ¬ ã‹ã›ãªã„æ“ä½œã§ã™ã€‚ä»Šå›ã¯ã€å …ç‰¢ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’å‚™ãˆãŸãƒšãƒ¼ã‚¸ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

## ç›®æ¬¡
1. åŸºæœ¬çš„ãªãƒšãƒ¼ã‚¸ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥é–¢æ•°
2. ãƒ­ã‚°æ©Ÿèƒ½ä»˜ãå®Œå…¨ç‰ˆ
3. ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ä»˜ãé«˜åº¦ãªå®Ÿè£…
4. å®Ÿè·µçš„ãªä½¿ç”¨ä¾‹
5. ãƒšãƒ¼ã‚¸ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

## å®Œå…¨å®Ÿè£…ã‚³ãƒ¼ãƒ‰

### selenium_refresh.py - ãƒšãƒ¼ã‚¸ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥æ©Ÿèƒ½

```python
"""
Selenium ãƒšãƒ¼ã‚¸ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥æ©Ÿèƒ½
ä¾‹å¤–å‡¦ç†ã€ãƒ­ã‚°ã€ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ã‚’å®Œå‚™
"""

import logging
from typing import Optional, Literal
from time import sleep
from selenium.webdriver.remote.webdriver import WebDriver
from selenium.common.exceptions import (
    WebDriverException,
    TimeoutException,
    NoSuchWindowException
)
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC

# ãƒ­ã‚¬ãƒ¼è¨­å®š
logger = logging.getLogger(__name__)


# ==================== ãƒ­ã‚°è¨­å®š ====================

def setup_logging(
    log_file: str = "logs/selenium_refresh.log",
    level: int = logging.INFO
) -> None:
    """
    ãƒ­ã‚°è¨­å®šã‚’åˆæœŸåŒ–
    
    Args:
        log_file: ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹
        level: ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«
    """
    import os
    
    log_dir = os.path.dirname(log_file)
    if log_dir:
        os.makedirs(log_dir, exist_ok=True)
    
    logging.basicConfig(
        level=level,
        format='%(asctime)s | %(levelname)-8s | [%(funcName)s] %(message)s',
        datefmt='%Y-%m-%d %H:%M:%S',
        handlers=[
            logging.FileHandler(log_file, encoding='utf-8'),
            logging.StreamHandler()
        ]
    )


# ==================== åŸºæœ¬çš„ãªãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥é–¢æ•° ====================

def refresh_page(driver: WebDriver) -> bool:
    """
    ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°ï¼ˆåŸºæœ¬ç‰ˆï¼‰
    
    Args:
        driver: WebDriverã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
    
    Returns:
        bool: æˆåŠŸæ™‚Trueã€å¤±æ•—æ™‚False
    
    Raises:
        WebDriverException: WebDriverã®æ“ä½œä¸­ã«å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆ
    """
    try:
        # ãƒšãƒ¼ã‚¸ã®ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥æ“ä½œ
        driver.refresh()
        print("ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚")
        return True
        
    except WebDriverException as e:
        print(f"ã‚¨ãƒ©ãƒ¼: ãƒšãƒ¼ã‚¸ã®æ›´æ–°ä¸­ã«WebDriverã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚è©³ç´°: {str(e)}")
        return False
        
    except Exception as e:
        print(f"äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}")
        return False


# ==================== ãƒ­ã‚°æ©Ÿèƒ½ä»˜ããƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥é–¢æ•° ====================

def refresh_page_with_logging(driver: WebDriver) -> bool:
    """
    ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°ï¼ˆãƒ­ã‚°æ©Ÿèƒ½ä»˜ãï¼‰
    
    Args:
        driver: WebDriverã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
    
    Returns:
        bool: æˆåŠŸæ™‚Trueã€å¤±æ•—æ™‚False
    """
    try:
        logger.info("ãƒšãƒ¼ã‚¸ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã‚’é–‹å§‹ã—ã¾ã™")
        
        # ç¾åœ¨ã®URLã‚’è¨˜éŒ²
        current_url = driver.current_url
        logger.debug(f"ç¾åœ¨ã®URL: {current_url}")
        
        # ãƒšãƒ¼ã‚¸ã®ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥æ“ä½œ
        driver.refresh()
        
        logger.info(f"âœ… ãƒšãƒ¼ã‚¸ã‚’æ­£å¸¸ã«æ›´æ–°ã—ã¾ã—ãŸ: {current_url}")
        return True
        
    except NoSuchWindowException as e:
        logger.error("âŒ ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒå­˜åœ¨ã—ã¾ã›ã‚“ï¼ˆæ—¢ã«é–‰ã˜ã‚‰ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼‰")
        logger.debug(f"ã‚¨ãƒ©ãƒ¼è©³ç´°: {str(e)}")
        return False
        
    except WebDriverException as e:
        logger.error(f"âŒ ãƒšãƒ¼ã‚¸ã®æ›´æ–°ä¸­ã«WebDriverã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ")
        logger.debug(f"ã‚¨ãƒ©ãƒ¼è©³ç´°: {str(e)}")
        return False
        
    except Exception as e:
        logger.error(f"âŒ äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}")
        logger.exception("ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹:")
        return False


# ==================== ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ä»˜ããƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥é–¢æ•° ====================

def refresh_page_with_retry(
    driver: WebDriver,
    retries: int = 3,
    delay: float = 1.0,
    wait_after_refresh: float = 2.0
) -> bool:
    """
    ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°ï¼ˆãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ä»˜ãï¼‰
    
    Args:
        driver: WebDriverã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
        retries: ãƒªãƒˆãƒ©ã‚¤å›æ•°
        delay: ãƒªãƒˆãƒ©ã‚¤é–“ã®å¾…æ©Ÿæ™‚é–“ï¼ˆç§’ï¼‰
        wait_after_refresh: ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å¾Œã®å¾…æ©Ÿæ™‚é–“ï¼ˆç§’ï¼‰
    
    Returns:
        bool: æˆåŠŸæ™‚Trueã€å¤±æ•—æ™‚False
    """
    logger.info(f"ãƒšãƒ¼ã‚¸ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥é–‹å§‹ (æœ€å¤§è©¦è¡Œå›æ•°: {retries})")
    
    for attempt in range(1, retries + 1):
        try:
            logger.debug(f"ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥è©¦è¡Œ {attempt}/{retries}")
            
            # ç¾åœ¨ã®URLã‚’è¨˜éŒ²
            current_url = driver.current_url
            logger.debug(f"ç¾åœ¨ã®URL: {current_url}")
            
            # ãƒšãƒ¼ã‚¸ã®ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥æ“ä½œ
            driver.refresh()
            
            # ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å¾Œã®å¾…æ©Ÿ
            if wait_after_refresh > 0:
                logger.debug(f"{wait_after_refresh}ç§’å¾…æ©Ÿä¸­...")
                sleep(wait_after_refresh)
            
            # ãƒšãƒ¼ã‚¸ãŒæ­£å¸¸ã«èª­ã¿è¾¼ã¾ã‚ŒãŸã‹ç¢ºèª
            try:
                WebDriverWait(driver, 10).until(
                    lambda d: d.execute_script('return document.readyState') == 'complete'
                )
                logger.debug("ãƒšãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ã¾ã—ãŸ")
            except TimeoutException:
                logger.warning("ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆå‡¦ç†ã¯ç¶™ç¶šï¼‰")
            
            logger.info(f"âœ… ãƒšãƒ¼ã‚¸ã‚’æ­£å¸¸ã«æ›´æ–°ã—ã¾ã—ãŸ (è©¦è¡Œ: {attempt}/{retries}): {current_url}")
            return True
            
        except NoSuchWindowException as e:
            logger.error(f"âŒ ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒå­˜åœ¨ã—ã¾ã›ã‚“ (è©¦è¡Œ {attempt}/{retries})")
            logger.debug(f"ã‚¨ãƒ©ãƒ¼è©³ç´°: {str(e)}")
            
            # ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒé–‰ã˜ã‚‰ã‚Œã¦ã„ã‚‹å ´åˆã¯å†è©¦è¡Œã—ãªã„
            logger.error("ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚¨ãƒ©ãƒ¼ã®ãŸã‚å‡¦ç†ã‚’ä¸­æ–­ã—ã¾ã™")
            return False
            
        except WebDriverException as e:
            logger.warning(f"âš ï¸ WebDriverã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ (è©¦è¡Œ {attempt}/{retries})")
            logger.debug(f"ã‚¨ãƒ©ãƒ¼è©³ç´°: {str(e)}")
            
            if attempt < retries:
                logger.info(f"â±ï¸ {delay}ç§’å¾Œã«å†è©¦è¡Œã—ã¾ã™...")
                sleep(delay)
            else:
                logger.error("âŒ ãƒªãƒˆãƒ©ã‚¤ã®ä¸Šé™ã«é”ã—ã¾ã—ãŸ")
                return False
                
        except Exception as e:
            logger.error(f"âŒ äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}")
            logger.exception("ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹:")
            
            if attempt < retries:
                logger.info(f"â±ï¸ {delay}ç§’å¾Œã«å†è©¦è¡Œã—ã¾ã™...")
                sleep(delay)
            else:
                logger.error("âŒ ãƒªãƒˆãƒ©ã‚¤ã®ä¸Šé™ã«é”ã—ã¾ã—ãŸ")
                return False
    
    return False


# ==================== æ¡ä»¶ä»˜ããƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥é–¢æ•° ====================

def refresh_if_stale(
    driver: WebDriver,
    timeout: float = 5.0,
    retries: int = 3
) -> bool:
    """
    ãƒšãƒ¼ã‚¸ãŒå¤ããªã£ã¦ã„ã‚‹ï¼ˆStaleï¼‰å ´åˆã®ã¿ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã™ã‚‹é–¢æ•°
    
    Args:
        driver: WebDriverã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
        timeout: è¦ç´ ãƒã‚§ãƒƒã‚¯ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚é–“ï¼ˆç§’ï¼‰
        retries: ãƒªãƒˆãƒ©ã‚¤å›æ•°
    
    Returns:
        bool: ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã—ãŸå ´åˆTrueã€ä¸è¦ã ã£ãŸå ´åˆã‚‚Trueã€å¤±æ•—æ™‚False
    """
    try:
        logger.info("ãƒšãƒ¼ã‚¸ã®çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯ä¸­...")
        
        # ãƒšãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿çŠ¶æ…‹ã‚’ç¢ºèª
        ready_state = driver.execute_script('return document.readyState')
        logger.debug(f"ãƒšãƒ¼ã‚¸çŠ¶æ…‹: {ready_state}")
        
        if ready_state != 'complete':
            logger.info("ãƒšãƒ¼ã‚¸ãŒå®Œå…¨ã«èª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„ãŸã‚ã€ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã—ã¾ã™")
            return refresh_page_with_retry(driver, retries=retries)
        
        logger.info("ãƒšãƒ¼ã‚¸ã¯æ­£å¸¸ãªçŠ¶æ…‹ã§ã™ï¼ˆãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ä¸è¦ï¼‰")
        return True
        
    except Exception as e:
        logger.error(f"âŒ ãƒšãƒ¼ã‚¸çŠ¶æ…‹ã®ãƒã‚§ãƒƒã‚¯ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ: {str(e)}")
        logger.info("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸãŸã‚ã€å¿µã®ãŸã‚ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã—ã¾ã™")
        return refresh_page_with_retry(driver, retries=retries)


# ==================== ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ä»˜ããƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ ====================

def hard_refresh(driver: WebDriver) -> bool:
    """
    ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¦ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ï¼ˆãƒãƒ¼ãƒ‰ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ï¼‰
    
    Args:
        driver: WebDriverã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
    
    Returns:
        bool: æˆåŠŸæ™‚Trueã€å¤±æ•—æ™‚False
    """
    try:
        logger.info("ãƒãƒ¼ãƒ‰ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã‚’å®Ÿè¡Œã—ã¾ã™ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ï¼‰")
        
        current_url = driver.current_url
        logger.debug(f"ç¾åœ¨ã®URL: {current_url}")
        
        # JavaScriptã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¦ãƒªãƒ­ãƒ¼ãƒ‰
        driver.execute_script("location.reload(true);")
        
        # ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å¾…æ©Ÿ
        sleep(2)
        
        try:
            WebDriverWait(driver, 10).until(
                lambda d: d.execute_script('return document.readyState') == 'complete'
            )
        except TimeoutException:
            logger.warning("ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ")
        
        logger.info(f"âœ… ãƒãƒ¼ãƒ‰ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å®Œäº†: {current_url}")
        return True
        
    except Exception as e:
        logger.error(f"âŒ ãƒãƒ¼ãƒ‰ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ: {str(e)}")
        logger.exception("ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹:")
        return False


# ==================== ãƒ†ã‚¹ãƒˆç”¨HTMLä½œæˆ ====================

def create_refresh_test_html() -> str:
    """ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒ†ã‚¹ãƒˆç”¨ã®HTMLã‚’ä½œæˆ"""
    html_content = """
    <!DOCTYPE html>
    <html lang="ja">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ãƒšãƒ¼ã‚¸ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒ†ã‚¹ãƒˆ</title>
        <style>
            body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                display: flex;
                justify-content: center;
                align-items: center;
                margin: 0;
                padding: 20px;
            }
            
            .container {
                background: white;
                padding: 40px;
                border-radius: 15px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                max-width: 600px;
                width: 100%;
            }
            
            h1 {
                color: #667eea;
                margin-bottom: 20px;
                text-align: center;
            }
            
            .info-box {
                background: #f8f9fa;
                padding: 20px;
                border-radius: 8px;
                margin: 20px 0;
                border-left: 4px solid #667eea;
            }
            
            .info-item {
                margin: 10px 0;
                display: flex;
                justify-content: space-between;
            }
            
            .label {
                font-weight: bold;
                color: #333;
            }
            
            .value {
                color: #667eea;
                font-family: monospace;
            }
            
            button {
                width: 100%;
                padding: 15px;
                margin: 10px 0;
                border: none;
                border-radius: 8px;
                font-size: 16px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s;
            }
            
            .btn-refresh {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
            }
            
            .btn-refresh:hover {
                transform: translateY(-2px);
                box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
            }
            
            .counter {
                font-size: 48px;
                text-align: center;
                color: #667eea;
                margin: 30px 0;
                font-weight: bold;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>ğŸ”„ ãƒšãƒ¼ã‚¸ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒ†ã‚¹ãƒˆ</h1>
            
            <div class="info-box">
                <div class="info-item">
                    <span class="label">ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å›æ•°:</span>
                    <span class="value" id="load-count">0</span>
                </div>
                <div class="info-item">
                    <span class="label">æœ€çµ‚èª­ã¿è¾¼ã¿æ™‚åˆ»:</span>
                    <span class="value" id="load-time">-</span>
                </div>
                <div class="info-item">
                    <span class="label">ã‚»ãƒƒã‚·ãƒ§ãƒ³ID:</span>
                    <span class="value" id="session-id">-</span>
                </div>
            </div>
            
            <div class="counter" id="counter">0</div>
            
            <button class="btn-refresh" onclick="manualRefresh()">
                æ‰‹å‹•ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
            </button>
        </div>
        
        <script>
            // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’localStorageã§ç®¡ç†
            let loadCount = parseInt(localStorage.getItem('loadCount') || '0') + 1;
            localStorage.setItem('loadCount', loadCount.toString());
            
            // ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’ç”Ÿæˆï¼ˆåˆå›ã®ã¿ï¼‰
            if (!sessionStorage.getItem('sessionId')) {
                sessionStorage.setItem('sessionId', 
                    Math.random().toString(36).substring(2, 15));
            }
            
            // æƒ…å ±ã‚’è¡¨ç¤º
            document.getElementById('load-count').textContent = loadCount;
            document.getElementById('load-time').textContent = 
                new Date().toLocaleTimeString('ja-JP');
            document.getElementById('session-id').textContent = 
                sessionStorage.getItem('sessionId');
            
            // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã®æ›´æ–°
            let counter = 0;
            setInterval(() => {
                counter++;
                document.getElementById('counter').textContent = counter;
            }, 1000);
            
            // æ‰‹å‹•ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
            function manualRefresh() {
                location.reload();
            }
            
            // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰å®Œäº†ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›
            window.addEventListener('load', () => {
                console.log('ãƒšãƒ¼ã‚¸ãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ:', {
                    loadCount: loadCount,
                    time: new Date().toISOString(),
                    sessionId: sessionStorage.getItem('sessionId')
                });
            });
        </script>
    </body>
    </html>
    """
    
    import os
    filepath = os.path.abspath("selenium_refresh_test.html")
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(html_content)
    
    return filepath


# ==================== ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆæ©Ÿèƒ½ ====================

def capture_screenshot(driver: WebDriver, filename: str, description: str = "") -> bool:
    """ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’æ’®å½±"""
    try:
        import os
        directory = os.path.dirname(filename)
        if directory:
            os.makedirs(directory, exist_ok=True)
        
        driver.save_screenshot(filename)
        
        if description:
            logger.info(f"ğŸ“¸ ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆä¿å­˜: {filename} | {description}")
        else:
            logger.info(f"ğŸ“¸ ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆä¿å­˜: {filename}")
        
        return True
    except Exception as e:
        logger.error(f"âŒ ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆæ’®å½±å¤±æ•—: {str(e)}")
        return False


# ==================== ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œé–¢æ•° ====================

def main():
    """ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œé–¢æ•°"""
    from selenium import webdriver
    from selenium.webdriver.chrome.options import Options
    
    # ãƒ­ã‚°è¨­å®š
    setup_logging(level=logging.INFO)
    
    logger.info("="*80)
    logger.info("ãƒšãƒ¼ã‚¸ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆé–‹å§‹")
    logger.info("="*80)
    
    # ãƒ†ã‚¹ãƒˆHTMLä½œæˆ
    html_path = create_refresh_test_html()
    logger.info(f"ãƒ†ã‚¹ãƒˆHTMLã‚’ä½œæˆ: {html_path}")
    
    # WebDriverã‚ªãƒ—ã‚·ãƒ§ãƒ³
    options = Options()
    options.add_argument('--start-maximized')
    
    # WebDriverèµ·å‹•
    logger.info("WebDriverã‚’èµ·å‹•ä¸­...")
    driver = webdriver.Chrome(options=options)
    
    try:
        # ===== TEST 1: åŸºæœ¬çš„ãªãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ =====
        logger.info("\n" + "="*80)
        logger.info("TEST 1: åŸºæœ¬çš„ãªãƒšãƒ¼ã‚¸ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥")
        logger.info("="*80)
        
        driver.get(f"file:///{html_path}")
        sleep(3)
        
        capture_screenshot(
            driver,
            "screenshots/refresh_01_initial.png",
            "åˆæœŸçŠ¶æ…‹"
        )
        
        # åŸºæœ¬çš„ãªãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
        refresh_page(driver)
        sleep(2)
        
        capture_screenshot(
            driver,
            "screenshots/refresh_02_after_basic.png",
            "åŸºæœ¬ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å¾Œ"
        )
        
        logger.info("âœ… TEST 1 å®Œäº†\n")
        
        # ===== TEST 2: ãƒ­ã‚°æ©Ÿèƒ½ä»˜ããƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ =====
        logger.info("="*80)
        logger.info("TEST 2: ãƒ­ã‚°æ©Ÿèƒ½ä»˜ããƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥")
        logger.info("="*80)
        
        sleep(3)
        refresh_page_with_logging(driver)
        sleep(2)
        
        capture_screenshot(
            driver,
            "screenshots/refresh_03_with_logging.png",
            "ãƒ­ã‚°ä»˜ããƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å¾Œ"
        )
        
        logger.info("âœ… TEST 2 å®Œäº†\n")
        
        # ===== TEST 3: ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ä»˜ããƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ =====
        logger.info("="*80)
        logger.info("TEST 3: ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ä»˜ããƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥")
        logger.info("="*80)
        
        sleep(3)
        refresh_page_with_retry(
            driver,
            retries=3,
            delay=1.0,
            wait_after_refresh=2.0
        )
        
        capture_screenshot(
            driver,
            "screenshots/refresh_04_with_retry.png",
            "ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ä»˜ããƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å¾Œ"
        )
        
        logger.info("âœ… TEST 3 å®Œäº†\n")
        
        # ===== TEST 4: æ¡ä»¶ä»˜ããƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ =====
        logger.info("="*80)
        logger.info("TEST 4: æ¡ä»¶ä»˜ããƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ï¼ˆãƒšãƒ¼ã‚¸çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯ï¼‰")
        logger.info("="*80)
        
        sleep(3)
        refresh_if_stale(driver, timeout=5.0, retries=3)
        
        capture_screenshot(
            driver,
            "screenshots/refresh_05_conditional.png",
            "æ¡ä»¶ä»˜ããƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å¾Œ"
        )
        
        logger.info("âœ… TEST 4 å®Œäº†\n")
        
        # ===== TEST 5: ãƒãƒ¼ãƒ‰ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ =====
        logger.info("="*80)
        logger.info("TEST 5: ãƒãƒ¼ãƒ‰ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ï¼‰")
        logger.info("="*80)
        
        sleep(3)
        hard_refresh(driver)
        sleep(2)
        
        capture_screenshot(
            driver,
            "screenshots/refresh_06_hard_refresh.png",
            "ãƒãƒ¼ãƒ‰ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å¾Œ"
        )
        
        logger.info("âœ… TEST 5 å®Œäº†\n")
        
        # ===== TEST 6: é€£ç¶šãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ =====
        logger.info("="*80)
        logger.info("TEST 6: é€£ç¶šãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒ†ã‚¹ãƒˆï¼ˆ3å›ï¼‰")
        logger.info("="*80)
        
        for i in range(1, 4):
            logger.info(f"\né€£ç¶šãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ {i}/3")
            sleep(2)
            refresh_page_with_retry(driver, retries=2, wait_after_refresh=1.5)
            
            capture_screenshot(
                driver,
                f"screenshots/refresh_07_continuous_{i}.png",
                f"é€£ç¶šãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ {i}å›ç›®"
            )
        
        logger.info("âœ… TEST 6 å®Œäº†\n")
        
        # æœ€çµ‚ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ
        sleep(2)
        capture_screenshot(
            driver,
            "screenshots/refresh_99_final.png",
            "æœ€çµ‚çŠ¶æ…‹"
        )
        
        # ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼
        logger.info("\n" + "="*80)
        logger.info("ğŸ‰ å…¨ãƒ†ã‚¹ãƒˆå®Œäº†!")
        logger.info("="*80)
        logger.info("å®Ÿè¡Œã•ã‚ŒãŸãƒ†ã‚¹ãƒˆ:")
        logger.info("  âœ… TEST 1: åŸºæœ¬çš„ãªãƒšãƒ¼ã‚¸ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥")
        logger.info("  âœ… TEST 2: ãƒ­ã‚°æ©Ÿèƒ½ä»˜ããƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥")
        logger.info("  âœ… TEST 3: ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ä»˜ããƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥")
        logger.info("  âœ… TEST 4: æ¡ä»¶ä»˜ããƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥")
        logger.info("  âœ… TEST 5: ãƒãƒ¼ãƒ‰ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ï¼‰")
        logger.info("  âœ… TEST 6: é€£ç¶šãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒ†ã‚¹ãƒˆ")
        logger.info("="*80)
        
    except Exception as e:
        logger.error(f"\nâŒ è‡´å‘½çš„ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ: {str(e)}")
        logger.exception("ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹:")
        
        try:
            capture_screenshot(
                driver,
                "screenshots/refresh_error.png",
                "ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚"
            )
        except:
            logger.error("ã‚¨ãƒ©ãƒ¼æ™‚ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆæ’®å½±ã‚‚å¤±æ•—")
    
    finally:
        logger.info("\n" + "="*80)
        logger.info("ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å‡¦ç†ä¸­...")
        logger.info("="*80)
        
        sleep(2)
        driver.quit()
        
        logger.info("âœ… WebDriverã‚’çµ‚äº†ã—ã¾ã—ãŸ")
        logger.info("="*80)
        logger.info("ãƒšãƒ¼ã‚¸ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆçµ‚äº†")
        logger.info("="*80)


if __name__ == "__main__":
    main()
```

## å®Ÿè¡Œæ–¹æ³•

```bash
# å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
pip install selenium

# ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œ
python selenium_refresh.py
```

## ã¾ã¨ã‚

### å®Ÿè£…ã—ãŸæ©Ÿèƒ½

1. **åŸºæœ¬çš„ãªãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥** - ã‚·ãƒ³ãƒ—ãƒ«ãªãƒšãƒ¼ã‚¸å†èª­ã¿è¾¼ã¿
2. **ãƒ­ã‚°æ©Ÿèƒ½ä»˜ã** - è©³ç´°ãªæ“ä½œãƒ­ã‚°ã‚’è¨˜éŒ²
3. **ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½** - å¤±æ•—æ™‚ã®è‡ªå‹•å†è©¦è¡Œ
4. **æ¡ä»¶ä»˜ããƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥** - ãƒšãƒ¼ã‚¸çŠ¶æ…‹ã«å¿œã˜ãŸå†èª­ã¿è¾¼ã¿
5. **ãƒãƒ¼ãƒ‰ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥** - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ä»˜ãå†èª­ã¿è¾¼ã¿

### ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

- ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å¾Œã¯å¿…ãšé©åˆ‡ãªå¾…æ©Ÿæ™‚é–“ã‚’è¨­ã‘ã‚‹
- ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ã‹ã‚‰æ¬¡ã®æ“ä½œã¸
- ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã¯ãƒ­ã‚°ã¨ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã§çŠ¶æ³ã‚’è¨˜éŒ²
- ãƒªãƒˆãƒ©ã‚¤å›æ•°ã¨å¾…æ©Ÿæ™‚é–“ã¯ç”¨é€”ã«å¿œã˜ã¦èª¿æ•´

ã“ã‚Œã§ã€ã‚ã‚‰ã‚†ã‚‹çŠ¶æ³ã«å¯¾å¿œã§ãã‚‹å …ç‰¢ãªãƒšãƒ¼ã‚¸ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥æ©Ÿèƒ½ãŒå®Ÿè£…ã§ãã¾ã—ãŸ!
